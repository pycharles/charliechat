{% extends "base.html" %}

{% block title %}Dev Journal - Charlie Chat{% endblock %}

{% block content %}
<!-- Mobile Journal Dropdown -->
<div class="mobile-journal-dropdown">
  <label for="journal-select" class="dropdown-label">ðŸ“– Select Article:</label>
  <select id="journal-select" class="journal-select">
    {% for entry in journal_entries %}
    <option value="/blog/{{ entry.slug }}" {% if loop.first %}selected{% endif %}>
      {{ entry.nav_date }} - {{ entry.nav_title }}
    </option>
    {% endfor %}
  </select>
</div>

<!-- Dev Journal Tab Content -->
<div class="tab-content active" id="journal-tab">
  <div class="journal-layout">
    <!-- Left Navigation -->
    <nav class="journal-nav">
      <div class="journal-nav-header">
        <h3>Journal Articles</h3>
      </div>
      <div class="journal-nav-content">
        {% for entry in journal_entries %}
        <a href="/blog/{{ entry.slug }}" class="nav-item" data-article="{{ entry.filename | replace('.md', '') }}">
          <div class="nav-item-date">{{ entry.nav_date }}</div>
          <div class="nav-item-title">{{ entry.nav_title }}</div>
        </a>
        {% endfor %}
      </div>
    </nav>

    <!-- Right Content -->
    <div class="journal-content">
      {% for entry in journal_entries %}
      <div class="journal-article" id="{{ entry.filename | replace('.md', '') }}" data-slug="{{ entry.slug }}">
        <h2>{{ entry.title }}</h2>
        <div class="article-meta">
          <time class="article-date">{{ entry.date }}</time>
        </div>
        <div class="article-content">
          {{ entry.content | safe }}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Image Modal -->
<div class="image-modal" id="imageModal">
  <div class="image-modal-overlay" onclick="closeImageModal()"></div>
  <div class="image-modal-content">
    <button class="image-modal-close" onclick="closeImageModal()">&times;</button>
    <img id="modalImage" src="" alt="">
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // Journal navigation functionality
  document.addEventListener('DOMContentLoaded', function() {
    const navItems = document.querySelectorAll('.journal-nav .nav-item');
    const articles = document.querySelectorAll('.journal-article');
    const journalSelect = document.getElementById('journal-select');
    
    // Check if we have a target slug from URL
    const urlParams = new URLSearchParams(window.location.search);
    const targetSlug = '{{ target_slug }}' || urlParams.get('article');
    
    let targetArticle = null;
    let targetNavItem = null;
    
    if (targetSlug && targetSlug !== 'None') {
      // Find the article with matching slug
      targetArticle = document.querySelector(`[data-slug="${targetSlug}"]`);
      targetNavItem = document.querySelector(`[href="/blog/${targetSlug}"]`);
    }
    
    // Show target article or first article by default
    if (targetArticle) {
      targetArticle.style.display = 'block';
      if (targetNavItem) {
        targetNavItem.classList.add('active');
      }
    } else if (articles.length > 0) {
      articles[0].style.display = 'block';
      if (navItems.length > 0) {
        navItems[0].classList.add('active');
      }
    }
    
    // Hide all articles except the target/first one
    articles.forEach((article, index) => {
      if (targetArticle && article === targetArticle) {
        article.style.display = 'block';
      } else if (!targetArticle && index === 0) {
        article.style.display = 'block';
      } else {
        article.style.display = 'none';
      }
    });
    
    // Handle dropdown selection
    if (journalSelect) {
      journalSelect.addEventListener('change', function() {
        const selectedValue = this.value;
        
        // Extract slug from URL
        let targetSlug = null;
        if (selectedValue.startsWith('/blog/')) {
          targetSlug = selectedValue.replace('/blog/', '');
        } else {
          // Fallback for old format
          const targetArticle = document.getElementById(selectedValue);
          if (targetArticle) {
            targetSlug = targetArticle.getAttribute('data-slug');
          }
        }
        
        if (targetSlug) {
          // Update URL without page reload
          const newUrl = `/blog/${targetSlug}`;
          window.history.pushState({}, '', newUrl);
          
          // Find and show the target article
          const targetArticle = document.querySelector(`[data-slug="${targetSlug}"]`);
          
          if (targetArticle) {
            // Update sidebar navigation
            navItems.forEach(nav => {
              nav.classList.remove('active');
              if (nav.getAttribute('href') === selectedValue) {
                nav.classList.add('active');
              }
            });
            
            // Hide all articles
            articles.forEach(article => {
              article.style.display = 'none';
            });
            
            // Show target article
            targetArticle.style.display = 'block';
          }
        }
      });
    }
    
    // Handle sidebar navigation clicks
    navItems.forEach(item => {
      item.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Get the href URL and extract slug
        const href = this.getAttribute('href');
        let targetSlug = null;
        
        if (href && href.startsWith('/blog/')) {
          targetSlug = href.replace('/blog/', '');
        } else {
          // Fallback to data-article for old format
          const targetId = this.getAttribute('data-article');
          const targetArticle = document.getElementById(targetId);
          if (targetArticle) {
            targetSlug = targetArticle.getAttribute('data-slug');
          }
        }
        
        if (targetSlug) {
          // Update URL without page reload
          const newUrl = `/blog/${targetSlug}`;
          window.history.pushState({}, '', newUrl);
          
          // Find and show the target article
          const targetArticle = document.querySelector(`[data-slug="${targetSlug}"]`);
          
          if (targetArticle) {
            // Remove active class from all nav items
            navItems.forEach(nav => nav.classList.remove('active'));
            
            // Add active class to clicked item
            this.classList.add('active');
            
            // Update dropdown selection
            if (journalSelect) {
              journalSelect.value = href;
            }
            
            // Hide all articles
            articles.forEach(article => {
              article.style.display = 'none';
            });
            
            // Show target article
            targetArticle.style.display = 'block';
          }
        }
      });
    });
    
    // Image modal functionality
    const images = document.querySelectorAll('.journal-article img, .entry-content img');
    images.forEach(img => {
      img.addEventListener('click', function() {
        openImageModal(this.src, this.alt);
      });
    });
  });
  
  // Image modal functions
  function openImageModal(src, alt) {
    const modal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    modalImage.src = src;
    modalImage.alt = alt;
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
  }
  
  function closeImageModal() {
    const modal = document.getElementById('imageModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto'; // Restore scrolling
  }
  
  // Close modal with Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeImageModal();
    }
  });
</script>
{% endblock %}