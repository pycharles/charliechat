{% extends "base.html" %}

{% block title %}Charlie Chat{% endblock %}

{% block content %}
<!-- Chat Tab Content -->
<div class="tab-content active" id="chat-tab">
  <div class="chat" id="chat">
    <div class="message message-bot">
      <div class="bubble">Hi, I'm Charlie. I'm ready when you are.</div>
    </div>
  </div>
  
  <!-- Voice Style Selector - Top Right of Chat -->
  <div class="voice-style-container">
    <!-- Discovery Label -->
    <div class="voice-discovery-label" id="voiceDiscoveryLabel">
      Curious? Switch voice styles to compare responses
    </div>
    
    <div class="chat-voice-selector">
      <button class="voice-style-btn" data-style="ninja" data-tooltip="Change voice style to ninja" aria-label="Change voice style to ninja">
        <img src="/static/ninja-star.svg" class="voice-icon" width="14" height="14" alt="Ninja">
      </button>
      <button class="voice-style-btn" data-style="pirate" data-tooltip="Change voice style to pirate" aria-label="Change voice style to pirate">
        <img src="/static/pirate01.svg" class="voice-icon" width="14" height="14" alt="Pirate">
      </button>
      <button class="voice-style-btn" data-style="surfer" data-tooltip="Change voice style to surfer dude" aria-label="Change voice style to surfer dude">
        <img src="/static/wave01.svg" class="voice-icon" width="14" height="14" alt="Surfer">
      </button>
      <button class="voice-style-btn active" data-style="normal" data-tooltip="Change voice style back to normal" aria-label="Change voice style back to normal">
        <img src="/static/person.svg" class="voice-icon" width="14" height="14" alt="Normal">
      </button>
    </div>
  </div>
  
  <div class="composer-container">
    <form class="composer" hx-post="/chat" hx-target="#chat" hx-swap="beforeend" hx-trigger="submit" hx-reset="true" hx-on::before-request="const chat=document.getElementById('chat'); const input=this.querySelector('.composer-input'); const text=(input && input.value || '').trim(); if(!text){event.preventDefault(); return;} if(window.isRequestInProgress){console.log('Duplicate request blocked - request already in progress'); event.preventDefault(); return;} window.isRequestInProgress=true; const userDiv=document.createElement('div'); userDiv.className='message message-user fade-in'; userDiv.innerHTML='<div class=\'bubble\'></div>'; userDiv.querySelector('.bubble').textContent=text; chat.appendChild(userDiv); let pending=document.getElementById('bot-pending'); if(pending) pending.remove(); pending=document.createElement('div'); pending.id='bot-pending'; pending.className='message message-bot pending fade-in'; pending.innerHTML='<div class=\'bubble\'><div class=\'thinking-dots\'><span class=\'thinking-dot\'></span><span class=\'thinking-dot\'></span><span class=\'thinking-dot\'></span></div></div>'; chat.appendChild(pending); chat.scrollTop=chat.scrollHeight; const sessionState=document.getElementById('session_state').value; console.log('=== FORM SUBMISSION DEBUG ==='); console.log('Sending session state:', sessionState); console.log('Session state length:', sessionState.length); console.log('Session state is empty object:', sessionState === '{}'); console.log('Session state input element exists:', !!document.getElementById('session_state')); console.log('Session state input value:', document.getElementById('session_state').value); console.log('=== END FORM SUBMISSION DEBUG ===');" hx-on::after-request="this.reset(); window.isRequestInProgress=false;" hx-on::response-error="window.isRequestInProgress=false;" hx-on::send-error="window.isRequestInProgress=false;" hx-disabled-elt=".composer-input, .composer-send">
      <input type="hidden" name="session_id" id="session_id" value="">
      <input type="hidden" name="session_state" id="session_state" value="">
      <input type="hidden" name="voice_style" id="voice_style_input" value="normal">
      <input class="composer-input" type="text" name="text" placeholder="Type your message..." autocomplete="off" required>
      <button class="composer-send" type="submit" onclick="if(window.isRequestInProgress){console.log('Duplicate request blocked - button click'); return false;}">Send</button>
    </form>
    
    <!-- Feedback Button - Above Send Button -->
    <button class="chat-feedback-btn" id="chat-feedback-fab" aria-label="Give Feedback" title="Give Feedback">
      <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" aria-hidden="true">
        <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
      </svg>
      <span class="feedback-text">Feedback</span>
    </button>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script src="/static/js/chat.js"></script>
{% endblock %}
